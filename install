#!/usr/bin/env bash

set -e

# Install brew if not installed
if [[ ! -f "${HOME}/.linuxbrew/bin/brew" && ! -f "/home/linuxbrew/.linuxbrew/bin/brew" ]]; then
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" | tee /tmp/brew_install.log
fi

if [ -f "${HOME}/.linuxbrew/bin/brew" ]; then
    eval $(${HOME}/.linuxbrew/bin/brew shellenv)
elif [ -f "/home/linuxbrew/.linuxbrew/bin/brew" ]; then
    eval $(/home/linuxbrew/.linuxbrew/bin/brew shellenv)
fi

BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

PLUGINS_DIR="${BASEDIR}/plugins"
DOTBOT_DIR="${BASEDIR}/dotbot"
DOTBOT_BIN="${DOTBOT_DIR}/bin/dotbot"

CONFIG_DIR="${BASEDIR}/config"
CONFIG="${CONFIG_DIR}/install.conf.yaml"
CONFIG_ROOT="${CONFIG_DIR}/install_root.conf.yaml"

export PATH="${HOME}/.local/bin:${PATH}"

cd "${BASEDIR}"
git submodule update --init --recursive 

python3 "${DOTBOT_BIN}" -d "${BASEDIR}" \
    --plugin-dir "${PLUGINS_DIR}/git" \
    --plugin-dir "${PLUGINS_DIR}/pip" \
    -c "${CONFIG}" "${@}"
