#!/usr/bin/env bash

set -e


function die() { echo "$*" 1>&2 ; exit 1; }


function usage () {
    echo "Usage: ./install [-b]"
    echo ""
    echo "Optional arguments:"
    echo "  -b, --no-brew           Do not intall brew"
    exit 0;
}


NO_BREW=false

while getopts "b-:" OPT; do
    if [[ "$OPT" == "-" ]]; then
        OPT="${OPTARG%%=*}"
        OPTARG="${OPTARG#$OPT}"
        OPTARG="${OPTARG#=}"
    fi

    case "$OPT" in
        b | no-brew ) NO_BREW=true ;;
        h | help ) usage ;;
        ? |??* ) die "Unknown option: $OPT" ;;
    esac
done

# Install brew if not installed
if [[ ! -f "${HOME}/.linuxbrew/bin/brew" && ! -f "/home/linuxbrew/.linuxbrew/bin/brew" && ${NO_BREW} == "false" ]]; then
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" | tee /tmp/brew_install.log
fi

# Source homebrew
if [ -f "${HOME}/.linuxbrew/bin/brew" ]; then
    eval $(${HOME}/.linuxbrew/bin/brew shellenv)
elif [ -f "/home/linuxbrew/.linuxbrew/bin/brew" ]; then
    eval $(/home/linuxbrew/.linuxbrew/bin/brew shellenv)
fi

if [[ ${NO_BREW} == "false" ]]; then
    brew install gcc zsh git fortune cowsay socat pyenv
    CC=$(brew --prefix gcc)/bin/gcc-11 pyenv install -s 3.10.2
    pyenv rehash
    pyenv global 3.10.2

    if command -v pyenv &> /dev/null; then
        export PYENV_ROOT="$HOME/.pyenv"
        eval "$(pyenv init --path)"
        eval "$(pyenv init -)"
    fi
fi

BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

PLUGINS_DIR="${BASEDIR}/plugins"
DOTBOT_DIR="${BASEDIR}/dotbot"
DOTBOT_BIN="${DOTBOT_DIR}/bin/dotbot"

CONFIG_DIR="${BASEDIR}/config"
CONFIG="${CONFIG_DIR}/install.conf.yaml"

export PATH="${HOME}/.local/bin:${PATH}"

cd "${BASEDIR}"
git submodule update --init --recursive 

python3 "${DOTBOT_BIN}" -d "${BASEDIR}" \
    --plugin-dir "${PLUGINS_DIR}/git" \
    --plugin-dir "${PLUGINS_DIR}/pip" \
    -c "${CONFIG}"
